<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <style>
        .date .col {
            min-height: 60px;
            font-size: 12px;
        }
    </style>
</head>

<body>


    <div class="container">
        <div class="row mt-3 text-center">
            <div class="col-md-12">
                <h3 id="year"></h3>
                <h5 id="month">
                    <button class="btn last">❮</button>

                    <button class="btn next">❯</button>
                </h5>
            </div>
        </div>

        <!-- Button trigger modal -->
        <div>
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#exampleModal">＋</button>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title fs-4" id="exampleModalLabel">新增行程</h2>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <h3 class="fs-5">日期</h3>
                        <input type="date" class="form-control" id="date" name="date">
                        <label class="fs-6 mb-2">請選擇日期</label>
                        <h3 class="fs-5">待辦事項</h3>
                        <textarea class="form-control" rows="3" id="todocontent"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="add">新增</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row text-center bg-body-tertiary">
            <div class="col border">日</div>
            <div class="col border">一</div>
            <div class="col border">二</div>
            <div class="col border">三</div>
            <div class="col border">四</div>
            <div class="col border">五</div>
            <div class="col border">六</div>
        </div>


        <div class="row text-center date">
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
        </div>
        <div class="row text-center date">
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
        </div>
        <div class="row text-center date">
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
        </div>
        <div class="row text-center date">
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
        </div>
        <div class="row text-center date">
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
        </div>
        <div class="row text-center date">
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
            <div class="col border">
                <div class="day">1</div>
            </div>
        </div>
    </div>




    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

    <script>

        let currentDate = new Date();
        let thisYear = currentDate.getFullYear();
        let thisMonth = currentDate.getMonth() + 1; // 月份是從 0 開始的，所以要加 1
        let thisMonthName = currentDate.toLocaleString("en-US", { month: "long" });
        let today = currentDate.getDay();
        let firstDay = new Date(thisYear, currentDate.getMonth(), 1);
        let lastDay = new Date(thisYear, currentDate.getMonth() + 1, 0)
        let firstDayOfWeek = firstDay.getDay(); // 0 表示星期日，1 表示星期一，以此類推
        let numberOfDays = lastDay.getDate();

        const titleYear = document.getElementById("year");
        const titleMonth = document.getElementById("month");
        let titleDays = Array.from(document.getElementsByClassName("day"));
        titleYear.innerText = thisYear;
        titleMonth.innerHTML = `<button class="btn last">❮</button>${thisMonthName}<button class="btn next">❯</button>`;
        for (let d = 0; d < titleDays.length; d++) {
            titleDays[d].innerText = new Date(thisYear, currentDate.getMonth(), 1 + d - firstDayOfWeek).getDate();
            if ((1 + d - firstDayOfWeek) > 0 && (1 + d - firstDayOfWeek) <= numberOfDays) {
                titleDays[d].dataset.monthName = thisMonth;
            }
        }

        const lastMonth = titleMonth.querySelector(".last");
        const nextMonth = titleMonth.querySelector(".next");
        lastMonth.addEventListener("click", function () {
            thisMonth--;
            if (thisMonth < 1) {
                thisMonth = 12;
                thisYear--;
            }
            titleYear.innerText = thisYear;
            // titleYear.innerText = new Date(thisYear, thisMonth - 1).getFullYear();
            thisMonthName = new Date(thisYear, thisMonth - 1).toLocaleString("en-US", { month: "long" });
            titleMonth.childNodes[1].nodeValue = thisMonthName;
            for (let d = 0; d < titleDays.length; d++) {
                firstDay = new Date(thisYear, thisMonth - 1, 1);
                lastDay = new Date(thisYear, thisMonth, 0)
                firstDayOfWeek = firstDay.getDay();
                numberOfDays = lastDay.getDate();
                titleDays[d].innerText = new Date(thisYear, thisMonth - 1, 1 + d - firstDayOfWeek).getDate();
                if ((1 + d - firstDayOfWeek) > 0 && (1 + d - firstDayOfWeek) <= numberOfDays) {
                    titleDays[d].dataset.monthName = thisMonth;
                }
            }
            getStorage();
        })
        nextMonth.addEventListener("click", () => {
            thisMonth++;
            if (thisMonth > 12) {
                thisMonth = 1;
                thisYear++;
            }
            titleYear.innerText = thisYear;
            // titleYear.innerText = new Date(thisYear, thisMonth - 1).getFullYear();
            thisMonthName = new Date(thisYear, thisMonth - 1).toLocaleString("en-US", { month: "long" });
            titleMonth.childNodes[1].nodeValue = thisMonthName;
            for (let d = 0; d < titleDays.length; d++) {
                firstDay = new Date(thisYear, thisMonth - 1, 1);
                lastDay = new Date(thisYear, thisMonth, 0)
                firstDayOfWeek = firstDay.getDay();
                numberOfDays = lastDay.getDate();
                titleDays[d].innerText = new Date(thisYear, thisMonth - 1, 1 + d - firstDayOfWeek).getDate();
                if ((1 + d - firstDayOfWeek) > 0 && (1 + d - firstDayOfWeek) <= numberOfDays) {
                    titleDays[d].dataset.monthName = thisMonth;
                }
            }
            getStorage();
        })


        let date = document.querySelector("#date");
        let todoList = document.querySelector("#todocontent");

        let btnAddTodo = document.getElementById("add");
        btnAddTodo.addEventListener("click", function () {
            let dateParts = date.value.split("-");
            let todoItems = {
                date: date.value,
                year: parseInt(dateParts[0]),
                month: parseInt(dateParts[1]),
                day: parseInt(dateParts[2]),
                todoList: todoList.value,
                todaytodo: ""
            };
            todoItems.todaytodo = todoItems.todaytodo ? todoItems.todaytodo : `${parseInt(dateParts[2])}<div class="text-bg-primary">${todoList.value}</div>`;

            titleDays.forEach((titleDay) => {
                if (todoItems.year == thisYear && todoItems.month == thisMonth && todoItems.day == titleDay.childNodes[0].textContent && todoItems.month == titleDay.dataset.monthName) {
                    let div = document.createElement("div");
                    div.classList.add("text-bg-primary");
                    div.innerText = todoItems.todoList;
                    titleDay.append(div);
                    div.addEventListener("click", function (event) {
                        event.target.remove();
                    })
                    todoItems.todaytodo = titleDay.innerHTML;
                }
            })
            let myToDoItemKey = date.value;
            let objToJson = JSON.stringify(todoItems);
            localStorage.setItem(myToDoItemKey, objToJson);
            todoList.value = "";
            date.value = "";
        })

        function getStorage() {
            for (let i = 0; i < localStorage.length; i++) {
                let key = localStorage.key(i);
                myToDoItems = JSON.parse(localStorage.getItem(key));
                titleDays.forEach((titleDay) => {
                    if (myToDoItems.year == thisYear && myToDoItems.month == thisMonth && myToDoItems.day == titleDay.childNodes[0].textContent && myToDoItems.month == titleDay.dataset.monthName) {
                        titleDay.innerHTML = myToDoItems.todaytodo;
                    }
                })
            }

            titleDays = Array.from(document.getElementsByClassName("day"));
            titleDays.forEach((titleDay) =>{
                [...titleDay.children].forEach((children) => {
                    children.addEventListener("click", function (event) {
                        event.target.remove();
                        myToDoItems.todaytodo = titleDay.innerHTML;
                        let myToDoItemKey = myToDoItems.date;
                        let objToJson = JSON.stringify(myToDoItems);
                        localStorage.setItem(myToDoItemKey, objToJson);
                    })
                })
            })
        }

        window.onload = function () {
            getStorage();
        }

    </script>


</body>

</html>